<script>
	import { gsap } from 'gsap'
	import { onMount } from 'svelte'

	export let x
	export let y

	let svgRef
	let pathRefs = []
	let isPressed = false
	let isAnimating = false

	// Button states
	export let state = 0 // 0 = normal, 1 = pressed
	export { state as buttonState } // Make state available to parent

	// Animation constants
	const ANIMATION_DURATION = 0.2 // Duration for each animation phase (seconds)
	const HOLD_DURATION = 0.005 // Duration to hold in pressed state (seconds)

	// Define path arrays for each animated path - all paths from button.svelte in order
	const pathData = [
		{
			// Path 0 - Main button shape
			from: 'M65.7902 105.078L121.832 72.7172L121.861 68.6441L63.3672 22.7109H56.3212L0.264865 67.2468L0.25 71.3198L58.7293 105.078H65.7902Z',
			to: 'M65.7902 104.828L121.832 72.4672L121.861 68.3941L63.3672 22.4609H56.3212L0.264865 66.9968L0.25 71.0698L58.7293 104.828H65.7902Z'
		},
		{
			// Path 1 - Second button layer
			from: 'M65.7902 79.4227L121.832 47.0614L121.861 42.9884L63.3672 9.21484L56.3212 9.22971L0.264865 41.591L0.25 45.6641L58.7293 79.4376L65.7902 79.4227Z',
			to: 'M65.7902 79.1727L121.832 46.8114L121.861 42.7384L63.3672 8.96484L56.3212 8.97971L0.264865 41.341L0.25 45.4141L58.7293 79.1876L65.7902 79.1727Z'
		},
		{
			// Path 2 - Top button face (fill)
			from: 'M64.7198 54.6712L108.171 29.5789L108.185 26.4275L62.8468 0.25L57.3765 0.264865L13.9406 25.3423L13.9258 28.4937L59.2495 54.6712L64.7198 54.6712Z',
			to: 'M64.7159 57.593L108.167 32.5007L108.182 29.3493L62.8429 3.17188L57.3726 3.18674L13.9367 28.2642L13.9219 31.4156L59.2456 57.593L64.7159 57.593Z'
		},
		{
			// Path 3 - Top button face (shadow)
			from: 'M64.7198 54.6712L108.171 29.5789L108.185 26.4275L62.8468 0.25L57.3765 0.264865L13.9406 25.3423L13.9258 28.4937L59.2495 54.6712L64.7198 54.6712Z',
			to: 'M64.7159 57.593L108.167 32.5007L108.182 29.3493L62.8429 3.17188L57.3726 3.18674L13.9367 28.2642L13.9219 31.4156L59.2456 57.593L64.7159 57.593Z'
		},
		{
			// Path 4 - Top button face (stroke)
			from: 'M64.7198 54.6712L108.171 29.5789L108.185 26.4275L62.8468 0.25L57.3765 0.264865L13.9406 25.3423L13.9258 28.4937L59.2495 54.6712L64.7198 54.6712Z',
			to: 'M64.7159 57.593L108.167 32.5007L108.182 29.3493L62.8429 3.17188L57.3726 3.18674L13.9367 28.2642L13.9219 31.4156L59.2456 57.593L64.7159 57.593Z'
		},
		{
			// Path 5 - Left side face
			from: 'M59.1289 69.2248L59.2478 54.6719L64.7182 54.6719L64.9858 69.2099L59.1289 69.2248Z',
			to: 'M59.1289 68.9748L59.1289 57.6719L64.9858 57.6719L64.9858 68.9599L59.1289 68.9748Z'
		},
		{
			// Path 6 - Right side face
			from: 'M64.9863 69.2085L64.7188 54.6704L108.169 29.5781L111.455 42.377L64.9863 69.2085Z',
			to: 'M64.9883 68.959L64.9883 57.6719L108.25 32.1719L111.457 42.1274L64.9883 68.959Z'
		},
		{
			// Path 7 - Left front face
			from: 'M10.625 41.2128L13.9251 28.4883L59.2488 54.6657L59.1298 69.2187L10.625 41.2128Z',
			to: 'M10.625 40.9628L13.9399 31.1719L59.2488 57.6719L59.1298 68.9687L10.625 40.9628Z'
		},
		{
			// Path 8 - Right front face
			from: 'M111.483 38.9868L108.183 26.4258L108.168 29.5772L111.453 40.8152L111.483 38.9868Z',
			to: 'M111.483 38.7372L108.262 29.1719L108.262 32.1719L111.483 42.1719L111.483 38.7372Z'
		},
		{
			// Path 9 - Left front face 2
			from: 'M13.9399 25.3398L10.6399 37.8265L10.625 41.2158L13.9251 28.4912L13.9399 25.3398Z',
			to: 'M13.9399 28.1719L10.6399 37.5765L10.625 40.9658L13.9399 31.1719L13.9399 28.1719Z'
		},
		{
			// Path 10 - Complex button detail (simplified for animation)
			from: 'M71.4515 37.039L82.2733 29.9335C82.8679 29.547 82.7341 28.8632 81.976 28.4173L80.2516 27.3916C79.8949 27.1686 79.657 26.901 79.5976 26.6037L79.0773 23.8537C79.0178 23.5712 78.7948 23.2888 78.4232 23.0658L67.4379 16.5252C67.0811 16.3171 66.6203 16.1833 66.1744 16.1535L53.8363 15.5441C53.3755 15.5144 52.9444 15.6184 52.662 15.8117L41.8402 22.9172C41.2456 23.3037 41.3794 23.9875 42.1375 24.4334L43.8619 25.4591C44.2186 25.6821 44.4565 25.9497 44.5159 26.247L45.0362 28.997C45.0957 29.2794 45.3186 29.5619 45.6903 29.7849L56.6904 36.3255C57.0472 36.5336 57.508 36.6674 57.954 36.6971L70.2771 37.2917C70.738 37.3215 71.1691 37.2174 71.4515 37.0242V37.039ZM64.7325 18.9928H64.896C65.3568 19.0225 65.8176 19.1563 66.1744 19.3644L78.0516 26.4253C78.8097 26.8713 78.9435 27.5551 78.3489 27.9416L69.1474 33.9768C68.865 34.1701 68.4487 34.2592 67.9879 34.2444H67.6609C66.7095 34.1849 65.8473 33.6795 65.7284 33.0849L64.6135 27.3024V27.1983L63.2162 20.0036C63.0973 19.409 63.7811 18.9631 64.7473 19.0077L64.7325 18.9928ZM45.9727 25.0132L55.308 18.8887C55.5904 18.6955 56.0066 18.6063 56.4675 18.6212C57.4188 18.6658 58.281 19.186 58.3999 19.7658L60.9121 32.8619C61.0311 33.4565 60.3473 33.9025 59.381 33.8579H59.2175C58.7567 33.8282 58.2959 33.6944 57.9391 33.4863C55.9769 32.3119 49.4214 28.4024 46.2551 26.5294C45.497 26.0834 45.3781 25.3996 45.9727 25.0132Z',
			to: 'M71.4515 40.209L82.2733 33.1035C82.8679 32.717 82.7341 32.0332 81.976 31.5873L80.2516 30.5616C79.8949 30.3386 79.657 30.071 79.5976 29.7737L79.0773 27.0237C79.0178 26.7412 78.7948 26.4588 78.4232 26.2358L67.4379 19.6952C67.0811 19.4871 66.6203 19.3533 66.1744 19.3235L53.8363 18.7141C53.3755 18.6844 52.9444 18.7884 52.662 18.9817L41.8402 26.0872C41.2456 26.4737 41.3794 27.1575 42.1375 27.6034L43.8619 28.6291C44.2186 28.8521 44.4565 29.1197 44.5159 29.417L45.0362 32.167C45.0957 32.4494 45.3186 32.7319 45.6903 32.9549L56.6904 39.4955C57.0472 39.7036 57.508 39.8374 57.954 39.8671L70.2771 40.4617C70.738 40.4915 71.1691 40.3874 71.4515 40.1942V40.209ZM64.7325 22.1628H64.896C65.3568 22.1925 65.8176 22.3263 66.1744 22.5344L78.0516 29.5953C78.8097 30.0413 78.9435 30.7251 78.3489 31.1116L69.1474 37.1468C68.865 37.3401 68.4487 37.4292 67.9879 37.4144H67.6609C66.7095 37.3549 65.8473 36.8495 65.7284 36.2549L64.6135 30.4724V30.3683L63.2162 23.1736C63.0973 22.579 63.7811 22.1331 64.7473 22.1777L64.7325 22.1628ZM45.9727 28.1832L55.308 22.0587C55.5904 21.8655 56.0066 21.7763 56.4675 21.7912C57.4188 21.8358 58.281 22.356 58.3999 22.9358L60.9121 36.0319C61.0311 36.6265 60.3473 37.0725 59.381 37.0279H59.2175C58.7567 36.9982 58.2959 36.8644 57.9391 36.6563C55.9769 35.4819 49.4214 31.5724 46.2551 29.6994C45.497 29.2534 45.3781 28.5696 45.9727 28.1832Z'
		},
		{
			// Path 11 - Right side detail
			from: 'M121.862 42.9844L121.862 68.6415L121.832 72.7146L121.832 47.0574L121.862 42.9844Z',
			to: 'M121.862 42.7344L121.862 68.3915L121.832 72.4646L121.832 46.8074L121.862 42.7344Z'
		},
		{
			// Path 12 - Left side detail
			from: 'M65.7891 105.073L65.7891 79.416L121.831 47.0547L121.831 72.7119L65.7891 105.073Z',
			to: 'M65.7891 104.823L65.7891 79.166L121.831 46.8047L121.831 72.4619L65.7891 104.823Z'
		},
		{
			// Path 13 - Bottom detail
			from: 'M58.7305 105.079L58.7305 79.4367L65.7914 79.4219L65.7914 105.079L58.7305 105.079Z',
			to: 'M58.7305 104.829L58.7305 79.1867L65.7914 79.1719L65.7914 104.829L58.7305 104.829Z'
		},
		{
			// Path 14 - Left bottom detail
			from: 'M0.25 71.3173L0.25 45.6602L58.7293 79.4337L58.7293 105.076L0.25 71.3173Z',
			to: 'M0.25 71.0673L0.25 45.4102L58.7293 79.1837L58.7293 104.826L0.25 71.0673Z'
		}
	]

	// Handle button click
	function handleClick() {
		if (isAnimating) return

		isAnimating = true
		state = state === 0 ? 1 : 0
		animateToPressed()
	}

	// Animate to pressed state
	function animateToPressed() {
		pathRefs.forEach((path, index) => {
			if (path && pathData[index]) {
				gsap.to(path, {
					duration: ANIMATION_DURATION,
					ease: 'power2.inOut',
					attr: { d: pathData[index].to },
					onComplete: () => {
						gsap.delayedCall(HOLD_DURATION, () => {
							animateToNormal()
						})
					}
				})
			}
		})

		// Animate fill-opacity for path 3 separately
		if (pathRefs[3]) {
			gsap.to(pathRefs[3], {
				duration: ANIMATION_DURATION,
				ease: 'power2.inOut',
				attr: { 'fill-opacity': 0.1 }
			})
		}
	}

	// Animate to normal state
	function animateToNormal() {
		pathRefs.forEach((path, index) => {
			if (path && pathData[index]) {
				gsap.to(path, {
					duration: ANIMATION_DURATION,
					ease: 'power2.inOut',
					attr: { d: pathData[index].from },
					onComplete: () => {
						isAnimating = false
					}
				})
			}
		})

		// Animate fill-opacity back to normal for path 3
		if (pathRefs[3]) {
			gsap.to(pathRefs[3], {
				duration: ANIMATION_DURATION,
				ease: 'power2.inOut',
				attr: { 'fill-opacity': state == 0 ? 0 : 0.05 }
			})
		}
	}

	onMount(() => {
		// Set initial path data
		pathRefs.forEach((path, index) => {
			if (path && pathData[index]) {
				path.setAttribute('d', pathData[index].from)
			}
		})
	})
</script>

<svg
	{x}
	{y}
	width="123"
	height="106"
	viewBox="0 0 123 106"
	fill="none"
	xmlns="http://www.w3.org/2000/svg"
	bind:this={svgRef}
	on:click={handleClick}
	on:keydown={(e) => e.key === 'Enter' && handleClick()}
	role="button"
	tabindex="0"
	aria-label="Animated button"
	style="cursor: pointer;"
>
	<path
		d="M65.7902 105.078L121.832 72.7172L121.861 68.6441L63.3672 22.7109H56.3212L0.264865 67.2468L0.25 71.3198L58.7293 105.078H65.7902Z"
		fill="#D9D9D9"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[0]}
	/>
	<path
		d="M65.7902 79.4227L121.832 47.0614L121.861 42.9884L63.3672 9.21484L56.3212 9.22971L0.264865 41.591L0.25 45.6641L58.7293 79.4376L65.7902 79.4227Z"
		fill="#D9D9D9"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[1]}
	/>
	<path
		d="M64.7198 54.6712L108.171 29.5789L108.185 26.4275L62.8468 0.25L57.3765 0.264865L13.9406 25.3423L13.9258 28.4937L59.2495 54.6712H64.7198Z"
		fill="#CDEF33"
		bind:this={pathRefs[2]}
	/>
	<path
		d="M64.7198 54.6712L108.171 29.5789L108.185 26.4275L62.8468 0.25L57.3765 0.264865L13.9406 25.3423L13.9258 28.4937L59.2495 54.6712H64.7198Z"
		fill="#202221"
		fill-opacity={state == 0 ? 0 : 0.05}
		bind:this={pathRefs[3]}
	/>
	<path
		d="M64.7198 54.6712L108.171 29.5789L108.185 26.4275L62.8468 0.25L57.3765 0.264865L13.9406 25.3423L13.9258 28.4937L59.2495 54.6712H64.7198Z"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[4]}
	/>
	<path
		d="M59.1289 69.2248L59.2478 54.6719H64.7182L64.9858 69.2099L59.1289 69.2248Z"
		fill="#CDEF33"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[5]}
	/>
	<path
		d="M64.9863 69.2085L64.7188 54.6704L108.169 29.5781L111.455 42.377L64.9863 69.2085Z"
		fill="#CDEF33"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[6]}
	/>
	<path
		d="M10.625 41.2128L13.9251 28.4883L59.2488 54.6657L59.1298 69.2187L10.625 41.2128Z"
		fill="#CDEF33"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[7]}
	/>
	<path
		d="M111.483 38.9868L108.183 26.4258L108.168 29.5772L111.453 40.8152L111.483 38.9868Z"
		fill="#CDEF33"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[8]}
	/>
	<path
		d="M13.9399 25.3398L10.6399 37.8265L10.625 41.2158L13.9251 28.4912L13.9399 25.3398Z"
		fill="#CDEF33"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[9]}
	/>
	<path
		d="M71.4515 37.039L82.2733 29.9335C82.8679 29.547 82.7341 28.8632 81.976 28.4173L80.2516 27.3916C79.8949 27.1686 79.657 26.901 79.5976 26.6037L79.0773 23.8537C79.0178 23.5712 78.7948 23.2888 78.4232 23.0658L67.4379 16.5252C67.0811 16.3171 66.6203 16.1833 66.1744 16.1535L53.8363 15.5441C53.3755 15.5144 52.9444 15.6184 52.662 15.8117L41.8402 22.9172C41.2456 23.3037 41.3794 23.9875 42.1375 24.4334L43.8619 25.4591C44.2186 25.6821 44.4565 25.9497 44.5159 26.247L45.0362 28.997C45.0957 29.2794 45.3186 29.5619 45.6903 29.7849L56.6904 36.3255C57.0472 36.5336 57.508 36.6674 57.954 36.6971L70.2771 37.2917C70.738 37.3215 71.1691 37.2174 71.4515 37.0242V37.039ZM64.7325 18.9928H64.896C65.3568 19.0225 65.8176 19.1563 66.1744 19.3644L78.0516 26.4253C78.8097 26.8713 78.9435 27.5551 78.3489 27.9416L69.1474 33.9768C68.865 34.1701 68.4487 34.2592 67.9879 34.2444H67.6609C66.7095 34.1849 65.8473 33.6795 65.7284 33.0849L64.6135 27.3024V27.1983L63.2162 20.0036C63.0973 19.409 63.7811 18.9631 64.7473 19.0077L64.7325 18.9928ZM45.9727 25.0132L55.308 18.8887C55.5904 18.6955 56.0066 18.6063 56.4675 18.6212C57.4188 18.6658 58.281 19.186 58.3999 19.7658L60.9121 32.8619C61.0311 33.4565 60.3473 33.9025 59.381 33.8579H59.2175C58.7567 33.8282 58.2959 33.6944 57.9391 33.4863C55.9769 32.3119 49.4214 28.4024 46.2551 26.5294C45.497 26.0834 45.3781 25.3996 45.9727 25.0132Z"
		fill="#202221"
		bind:this={pathRefs[10]}
	/>
	<path
		d="M121.862 42.9844V68.6415L121.832 72.7146V47.0574L121.862 42.9844Z"
		fill="#D9D9D9"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[11]}
	/>
	<path
		d="M65.7891 105.073V79.416L121.831 47.0547V72.7119L65.7891 105.073Z"
		fill="#D9D9D9"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[12]}
	/>
	<path
		d="M58.7305 105.079V79.4367L65.7914 79.4219V105.079H58.7305Z"
		fill="#D9D9D9"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[13]}
	/>
	<path
		d="M0.25 71.3173V45.6602L58.7293 79.4337V105.076L0.25 71.3173Z"
		fill="#D9D9D9"
		stroke="#202221"
		stroke-width="0.5"
		stroke-linecap="round"
		stroke-linejoin="round"
		bind:this={pathRefs[14]}
	/>
</svg>

<style>
	svg {
		outline: none;
		-webkit-tap-highlight-color: transparent;
		-webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}

	svg:focus {
		outline: none;
	}

	svg:active {
		outline: none;
	}
</style>
